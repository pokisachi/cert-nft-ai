datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// -------------------------
// BẢNG USER
// -------------------------
model User {
  id            Int       @id @default(autoincrement())
  email         String    @unique
  name          String?
  dob           DateTime?
  idcard        String?
  role          Role      @default(LEARNER)
  walletAddress String?   @unique
  phone         String?
  address       String?
  avatarUrl     String?
  createdAt     DateTime  @default(now())

  profileCompleted Boolean @default(false)
  name_norm        String?
  phone_e164       String?
  row_version      BigInt  @default(1)

  examResults       ExamResult[]
  certificates      Certificate[]
  notifications     Notification[]
  notificationReads NotificationRead[]
  enrollments       Enrollment[]
  auditLogs         AuditLog[]      // ✅ thêm quan hệ với AuditLog
}

// -------------------------
// BẢNG COURSE (HỢP NHẤT CHO GA)
// -------------------------
model Course {
  id               Int          @id @default(autoincrement())
  title            String
  description      String?
  category         String
  startDate        DateTime?
  endDate          DateTime?
  examDateExpected DateTime?
  status           CourseStatus @default(UPCOMING)
  isPublic         Boolean      @default(true)
  thumbnail        String?
  createdAt        DateTime     @default(now())

  examSessions     ExamSession[]
  certificates     Certificate[]
  notifications    Notification[]
  enrollments      Enrollment[]
  lessons          LessonTemplate[]
  scheduledClasses ScheduledClass[]

  structure_lessons_per_week Int    @default(3)
  structure_lesson_duration  Int    @default(90)
  requirement_qualification  String @default("TOEIC_450")
}

// -------------------------
// BẢNG LESSON TEMPLATE 
// -------------------------
model LessonTemplate {
  id       Int     @id @default(autoincrement())
  title    String  @default("Untitled")
  content  String?
  courseId Int
  course   Course  @relation(fields: [courseId], references: [id])
}

// -------------------------
// BẢNG EXAM SESSION
// -------------------------
model ExamSession {
  id       Int          @id @default(autoincrement())
  courseId Int
  course   Course       @relation(fields: [courseId], references: [id])
  room     String
  date     DateTime
  capacity Int
  results  ExamResult[]
}

// -------------------------
// 
// -------------------------
model ExamResult {
  id            Int        @id @default(autoincrement())
  examSessionId Int
  userId        Int
  score         Int?
  status        ExamStatus
  locked        Boolean     @default(false)

  examSession ExamSession  @relation(fields: [examSessionId], references: [id], onDelete: Cascade)
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  certificate Certificate? @relation("ExamResultToCertificate")

  @@unique([examSessionId, userId])
  @@index([examSessionId, status]) 
}


// -------------------------
// BẢNG NOTIFICATION
// -------------------------
model Notification {
  id         Int      @id @default(autoincrement())
  title      String
  content    String
  targetRole Role?
  userId     Int?
  courseId   Int?
  isPinned   Boolean  @default(false)
  createdAt  DateTime @default(now())

  user   User?              @relation(fields: [userId], references: [id])
  course Course?            @relation(fields: [courseId], references: [id])
  reads  NotificationRead[]
}

// -------------------------
// BẢNG NOTIFICATION READ
// -------------------------
model NotificationRead {
  id             Int      @id @default(autoincrement())
  userId         Int
  notificationId Int
  readAt         DateTime @default(now())

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  notification Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)

  @@unique([userId, notificationId])
}

// -------------------------
// 
// -------------------------
model Certificate {
  id           Int      @id @default(autoincrement())
  userId       Int
  courseId     Int
  examResultId Int?     @unique
  tokenId      String   @unique      
  ipfsCid      String   @unique
  docHash      String   @unique
  txHash       String?                
  issuedAt     DateTime @default(now())
  revoked      Boolean  @default(false)
  updatedAt    DateTime @updatedAt

  user       User        @relation(fields: [userId], references: [id])
  course     Course      @relation(fields: [courseId], references: [id])
  examResult ExamResult? @relation("ExamResultToCertificate", fields: [examResultId], references: [id])

  @@unique([userId, courseId])
}

// -------------------------
// BẢNG ENROLLMENT
// -------------------------
model Enrollment {
  id             Int          @id @default(autoincrement())
  userId         Int
  courseId       Int
  status         EnrollStatus @default(PENDING)
  availableSlots String[]     @default([])
  enrolledAt     DateTime     @default(now())

  user                 User                  @relation(fields: [userId], references: [id])
  course               Course                @relation(fields: [courseId], references: [id])
  scheduledEnrollments ScheduledEnrollment[]

  @@unique([userId, courseId])
}

// -------------------------
// GIÁO VIÊN / PHÒNG / LỊCH HỌC
// -------------------------
model Teacher {
  id           String   @id @default(cuid())
  name         String
  availability String[]
  createdAt    DateTime @default(now())
  updatedAt    DateTime @default(now()) @updatedAt

  qualifications   TeacherQualification[]
  scheduledClasses ScheduledClass[]
}

model Qualification {
  id          String   @id @default(cuid())
  name        String
  category    String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  teachers TeacherQualification[]
}

model TeacherQualification {
  id              String        @id @default(cuid())
  teacherId       String
  qualificationId String
  teacher         Teacher       @relation(fields: [teacherId], references: [id])
  qualification   Qualification @relation(fields: [qualificationId], references: [id])
}

model Room {
  id               String           @id
  capacity         Int
  availability     String[]         @default([])
  scheduledClasses ScheduledClass[]

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

model ScheduledClass {
  id        Int      @id @default(autoincrement())
  courseId  Int
  teacherId String
  roomId    String
  dayOfWeek String
  timeSlot  String
  startDate DateTime
  endDate   DateTime
  createdAt DateTime @default(now())

  course               Course                @relation(fields: [courseId], references: [id])
  teacher              Teacher               @relation(fields: [teacherId], references: [id])
  room                 Room                  @relation(fields: [roomId], references: [id])
  scheduledEnrollments ScheduledEnrollment[]
}

model ScheduledEnrollment {
  id               Int      @id @default(autoincrement())
  scheduledClassId Int
  enrollmentId     Int
  assignedAt       DateTime @default(now())

  scheduledClass ScheduledClass @relation(fields: [scheduledClassId], references: [id])
  enrollment     Enrollment     @relation(fields: [enrollmentId], references: [id])

  @@unique([scheduledClassId, enrollmentId])
}

// -------------------------
// BẢNG AUDIT LOG
// -------------------------
model AuditLog {
  id        Int      @id @default(autoincrement())
  actorId   Int?
  action    String
  entity    String?
  entityId  String?
  payload   Json?
  createdAt DateTime  @default(now())

  actor     User?     @relation(fields: [actorId], references: [id])
}

// -------------------------
// ENUMS
// -------------------------
enum EnrollStatus {
  PENDING
  ACTIVE
  COMPLETED
  CANCELED
}

enum Role {
  ADMIN
  LEARNER
  ALL
}

enum ExamStatus {
  PENDING
  PASS
  FAIL
}

enum CourseStatus {
  UPCOMING
  ONGOING
  COMPLETED
  CLOSED
}
enum DedupStatus {
  unique
  suspected_copy
  duplicate
}

model AIDedupResult {
  id              Int          @id @default(autoincrement())
  examResultId    Int
  userId          Int
  courseId        Int
  preIssueHash    String
  status          DedupStatus
  similarityScore Float
  checkedAt       DateTime     @default(now())

  @@unique([userId, courseId, preIssueHash])
  @@index([userId, courseId, checkedAt])
  @@index([examResultId])
}
